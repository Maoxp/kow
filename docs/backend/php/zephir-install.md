# Zephir

## 简介

> [Zephir](https://docs.zephir-lang.com/latest/) 是一种专门为 PHP 扩展开发设计的高级语言。它允许开发人员使用类似于 PHP 语法的语言来编写扩展，并将其编译成 C 代码，然后再通过 PHP 扩展机制加载到 PHP 中,相比于直接使用 C 或 C++ 编写扩展，它可以显著减少开发时间和复杂性。
>
> 由于语法与 PHP 类似，PHP 开发人员可以更快速地学习和使用它来编写扩展。
>
> 需注意的是与 PHP 不同，Zephir 支持静态类型，这有助于提高代码的可读性和性能。

## 主要特点

- 类型系统：态/静态
- 内存安全：不允许使用指针或直接内存管理
- 编译模型：预编译
- 内存模型：任务本地垃圾回收

## 环境依赖

> 在使用 Zephir 构建 PHP 扩展之前，请确保您满足以下要求:

- Zephir parser >= 1.3.0
- re2c 0.13.6 或更高版本
- C 编译器（如 gcc >= 4.4）或替代编译器（如 [clang](https://clang.llvm.org/) >= 3.0、[Visual C++ ](https://support.microsoft.com/en-us/help/2977003/the-latest-supported-visual-c-downloads)>= 11 或 [Intel C++](https://software.intel.com/en-us/c-compilers)）。建议使用 `gcc` 4.4 或更高版本
- [automake](https://www.gnu.org/software/automake/) 1.14 or later
-  [GNU make](https://www.gnu.org/software/make/) 3.81 or later
-  [autoconf](https://www.gnu.org/software/autoconf/autoconf.html) 2.31 or later
- libpcre3
- PHP development headers and tools



On Ubuntu, 你可以 install the required packages包含：

```shell
sudo apt-get update
sudo apt-get install git gcc make re2c php php-json php-dev libpcre3-dev build-essential
```

Ensure 你的 PHP 已正常安装

```shell
php -v
PHP 8.0.30 (cli) (built: Nov 21 2023 16:16:21) ( NTS )
Copyright (c) The PHP Group
Zend Engine v4.0.30, Copyright (c) Zend Technologies
    with Xdebug v3.3.1, Copyright (c) 2002-2023, by Derick Rethans
```

此外，检查 PHP 开发库是否安装

```shell
phpize -v
Configuring for:
PHP Api Version:         20200930
Zend Module Api No:      20200930
Zend Extension Api No:   420200930
```

## 安装 Zephir

> 第一步 要确保 Zephir parser extnesion 已被安装和启用。你可以再 [Zephir Parser repository](https://github.com/zephir-lang/php-zephir-parser) 上find installation instructions.

### Part1 Zephir 解析器

安装 **zephir-parser** 有多种方式。可以选择源码编译安装 或者`pecl`方式安装。

#### *1) 编译方式*

```shell
git clone git://github.com/zephir-lang/php-zephir-parser.git
cd php-zephir-parser
phpize
./configure --with-php-config=/usr/local/php-7.4/bin/php-config
make
sudo make install
```

添加动态扩展库 php-zephir-parser

```shell
sudo vim /usr/local/php-7.4/etc/php.ini

# 添加如下内容至 php.ini
[Zephir Parser]
extension=zephir_parser.so
```

#### *2) pecl方式*

```shell
pecl instal zephir_parser
```

依据你的系统环境，你 might need 创建一个 `zephir_parser.ini` file, 用来加载此扩展。 文件的内容如下：

```shell
extension=zephir_parser.so
```

### Part2 安装 zephir

#### *1) Release Phar*

> 您可以从 Github上 [here](https://github.com/phalcon/zephir/releases) 下载最新的 zephir.phar。将文件移动到 `PATH` 中可用的文件夹，例如 `/usr/local/bin`，并使其可执行：

```shell
mv zephir.phar /usr/local/bin 
cd /usr/local/bin/
mv zephir.phar zephir 
chmod a+x zephir
```

您可能还需要更改文件的所有权，具体取决于您的环境。

#### *2) Composer 方式*

推荐安装方法是使用 composer:

```shell
composer require phalcon/zephir
# 我这里的安装路径是`/home/www/build/demo-zephir/vendor/bin`
```

确保将 `${COMPOSER_HOME}/vendor/bin`添加到`$PATH`。使之能在任意地方，命令行下使用。

##### 2.1) Project

使用 `composer exec zephir` 命令可以在当前项目中运行 `zephir` (你也可以 run `vendor/bin/zephir` ).

##### 2.2) Global

全局安装使用，可以：

```shell
composer global require phalcon/zephir
```

###### 2.3) Git clone

从 Github 上 clone 最新的 tag，安装 dependencies 和从当前位置运行 zephir

```shell
git clone --depth 1 -b $(git ls-remote https://github.com/zephir-lang/zephir 0.15.* | sort -t/ -k3 -Vr | head -n1 | awk -F/ '{ print $NF }') https://github.com/zephir-lang/zephir
cd zephir
# 安装依赖
composer install
```

> 安装后，当前目录下会生成一个可执行的二进制文件 `zephir`

添加环境变量, 以使用运行 Zephir。

#### 测试运行

如果成功安装 zephir，控制台下你可以看到如下命令输出：

```bash
zephir help

_____              __    _
/__  /  ___  ____  / /_  (_)____
  / /  / _ \/ __ \/ __ \/ / ___/
 / /__/  __/ /_/ / / / / / /
/____/\___/ .___/_/ /_/_/_/
         /_/

Zephir 0.17.0 by Andres Gutierrez and Serghei Iakovlev (9f99da6)

Usage:
  command [options] [arguments]

Options:
      --dumpversion  Print the version of the compiler and don't do anything else (also works with a single hyphen)
  -h, --help         Print this help message
      --no-ansi      Disable ANSI output
  -v, --verbose      Displays more detail in error messages from exceptions generated by commands (can also disable with -V)
      --vernum       Print the version of the compiler as integer
      --version      Print compiler version information and quit

Available commands:
  api        Generates a HTML API based on the classes exposed in the extension
  build      Generates/Compiles/Installs a Zephir extension
  clean      Cleans any object files created by the extension
  compile    Compile a Zephir extension
  fullclean  Cleans any object files created by the extension (including files generated by phpize)
  generate   Generates C code from the Zephir code without compiling it
  help       Display help for a command
  init       Initializes a Zephir extension
  install    Installs the extension in the extension directory (may require root password)
  stubs      Generates stubs that can be used in a PHP IDE

```

## 其他选择

A C++ library for developing PHP extensions: [php-cpp](https://www.php-cpp.com/)
